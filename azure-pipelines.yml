# Nome da pipeline de CI (Build)
name: GlobalSolution-SkillMatch-CI

# Gatilho: Roda sempre que houver um push na branch 'main'
trigger:
  - main

# Pool de Agentes: Usa o seu agente local
pool:
  name: 'Meu-Agente-Local'

# Variáveis usadas na pipeline
variables:
  # O nome do seu ACR (que você criou no Portal)
  azureContainerRegistry: 'acrskillmatchfiap.azurecr.io'
  
  # O nome da imagem Docker que será criada
  imageName: 'skillmatch-api'
  
  # O nome da Conexão de Serviço (que você criou no DevOps)
  dockerRegistryServiceConnection: 'ConexaoACR'

# Etapas do Build (CI)
stages:
  - stage: Build
    displayName: 'Build, Test & Push Docker Image'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Java Application'
        steps:
          # 1. RODA MAVEN COM TESTES + PUBLICA RESULTADOS (15 PTS!)
          - task: Maven@3
            displayName: 'Run Maven Package (WITH TESTS)'
            inputs:
              mavenPomFile: 'pom.xml'
              # CORREÇÃO: Adicionando 'test' para forçar a execução da fase de testes
              goals: 'clean test package' 
              # CORREÇÃO: Removendo o -DskipTests=false, pois 'false' é o padrão
              options: '' 
              javaHomeOption: 'Path'
              jdkDirectory: '$(JAVA_HOME)'
              publishJUnitResults: true     # PUBLICA NO AZURE DEVOPS!
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              codeCoverageToolOption: 'JaCoCo'

          # 2. Constrói a Imagem Docker
          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
              containerRegistry: $(dockerRegistryServiceConnection)
              repository: $(imageName)
              command: 'build'
              Dockerfile: 'Dockerfile'
              tags: |
                $(Build.BuildId)
                latest

          # 3. Push para ACR
          - task: Docker@2
            displayName: 'Push Docker Image to ACR'
            inputs:
              containerRegistry: $(dockerRegistryServiceConnection)
              repository: $(imageName)
              command: 'push'
              tags: |
                $(Build.BuildId)
                latest

          # 4. Publica os Scripts de Infra (para usar no CD)
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Infra Scripts Artifact'
            inputs:
              PathtoPublish: 'scripts'
              ArtifactName: 'infra-scripts'
