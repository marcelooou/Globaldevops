# ===============================================
# PIPELINE CI - GlobalSolution-SkillMatch-CI
# JAVA 17 + TESTES + DOCKER + INFRA (SEM skipTests)
# ===============================================

name: GlobalSolution-SkillMatch-CI

trigger:
  - main

pool:
  name: 'Meu-Agente-Local'

variables:
  azureContainerRegistry: 'acrskillmatchfiap.azurecr.io'
  imageName: 'skillmatch-api'
  dockerRegistryServiceConnection: 'ConexaoACR'

stages:
  - stage: Build
    displayName: 'Build, Test & Push Docker Image'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Java Application'
        steps:

          # ===============================================
          # 1. DEBUG - CHECA JAVA E MAVEN NO AGENTE
          # ===============================================
          - script: |
              echo ======== DEBUG JAVA & MAVEN ========
              echo JAVA_HOME=%JAVA_HOME%
              where java
              "C:\Users\neibo\Desktop\apache-maven-3.9.11-bin\apache-maven-3.9.11\bin\mvn.cmd" -version
            displayName: 'Debug: check Java and Maven'

          # ===============================================
          # 2. MAVEN - BUILD + TESTES (JUnit + JaCoCo)
          # ===============================================
          - task: Maven@3
            displayName: 'Run Maven Package (WITH TESTS)'
            env:
              JAVA_HOME: 'C:\Program Files\Eclipse Adoptium\jdk-17.0.10.7-hotspot'  # <--- AJUSTE AQUI o caminho exato do seu JDK 17
              PATH: 'C:\Program Files\Eclipse Adoptium\jdk-17.0.10.7-hotspot\bin;$(PATH)'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean verify'
              options: '-Dmaven.test.failure.ignore=false'
              javaHomeOption: 'Path'
              jdkDirectory: 'C:\Program Files\Eclipse Adoptium\jdk-17.0.10.7-hotspot'  # mesmo caminho acima
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              codeCoverageToolOption: 'JaCoCo'

          # ===============================================
          # 3. DOCKER BUILD
          # ===============================================
          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
              containerRegistry: $(dockerRegistryServiceConnection)
              repository: $(imageName)
              command: 'build'
              Dockerfile: 'Dockerfile'
              tags: |
                $(Build.BuildId)
                latest

          # ===============================================
          # 4. DOCKER PUSH
          # ===============================================
          - task: Docker@2
            displayName: 'Push Docker Image to ACR'
            inputs:
              containerRegistry: $(dockerRegistryServiceConnection)
              repository: $(imageName)
              command: 'push'
              tags: |
                $(Build.BuildId)
                latest

          # ===============================================
          # 5. PUBLICAÇÃO DOS SCRIPTS DE INFRA
          # ===============================================
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Infra Scripts'
            inputs:
              PathtoPublish: 'scripts'
              ArtifactName: 'infra-scripts'
